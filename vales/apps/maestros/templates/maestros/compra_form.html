{% extends 'maestro_form.html' %}
{% load static %}
<!-- -------------------------------------------------------------------- -->
{% block maincomponent %}
	{% block principalcomponent %}
		<div id="layoutSidenav_content">
			<main>
				<div class="container-fluid">
					
					<div class="card border-light mb-3 mt-2">
						<div class="card-header text-white bg-primary opacity-75 d-flex 
									justify-content-between">
							{{ accion }}
							<div class="flex align-items-center">
								<a 
									class="me-2 text-white" 
									data-bs-toggle="modal" 
									data-bs-target="#helpModal" 
									style="cursor: pointer;">
									<i class="bi bi-question-lg"></i></a>
								
								<button type="button" class="btn-close btn-close-white" 
									aria-label="Close"
									onclick="window.location.href='{% url list_view_name %}'">
								</button>
							</div>
						</div>
						
						<div class="card-body bg-body-secondary">
							<form method="post" enctype="multipart/form-data" novalidate>
								{% csrf_token %}
								<div class="accordion" id="accordionPanelsStayOpenExample">
									<!-- Estructura generada -->
									
									<div class="accordion-item">
										<h2 class="accordion-header">
											<button 
												class="accordion-button py-2 " 
												type="button" 
												data-bs-toggle="collapse" 
												data-bs-target="#Compras_Socios" 
												aria-expanded="true" 
												aria-controls="Compras_Socios">
												<strong>Compras Socios</strong>
											</button>
										</h2>
										<div class="accordion-collapse collapse show"
											id="Compras_Socios">
											<div class="accordion-body bg-secondary-subtle">
												
												<div class="row">
													
													<div class="col-md-2">
														<label class="form-label text-primary mb-0">
															{{ form.estatus_compra.label }}
														</label>
														{{ form.estatus_compra }}
													</div>
												</div>										
												<div class="row">
													<div class="col-md-3">
														<label class="form-label text-primary mb-0">
															{{ form.id_solicitud_vale.label }}
														</label>
														{{ form.id_solicitud_vale }}
													</div>
													
													<div class="col-md-3">
														<label class="form-label text-primary mb-0">
															{{ form.id_socio.label }}
														</label>
														{{ form.id_socio }}
													</div>
													
													<div class="col-md-3">
														<label class="form-label text-primary mb-0">
															{{ form.id_comercio.label }}
														</label>
														{{ form.id_comercio }}
													</div>
												</div>										
												<div class="row">
													
													<div class="col-md-3">
														<label class="form-label text-primary mb-0">
															{{ form.id_plan.label }}
														</label>
														{{ form.id_plan }}
													</div>
													
													<div class="col-md-2">
														<label class="form-label text-primary mb-0">
															{{ form.monto_compra.label }}
														</label>
														{{ form.monto_compra }}
													</div>
												</div>										
												<div class="row">
													
													<div class="col-md-2">
														<label class="form-label text-primary mb-0">
															{{ form.estado_compra.label }}
														</label>
														{{ form.estado_compra }}
													</div>
													
													<div class="col-md-2">
														<label class="form-label text-primary mb-0">
															{{ form.fecha_compra.label }}
														</label>
														{{ form.fecha_compra }}
													</div>

													<div class="col-md-2">
														<label class="form-label text-primary mb-0">
															{{ form.autorizacion_compra.label }}
														</label>
														{{ form.autorizacion_compra }}
													</div>
												</div>
											</div>
										</div>
									</div>
								
								</div>
								
								<div class="container mt-3">
									<button class="btn btn-primary" type="submit" id="guardarBtn">
										Guardar
									</button>
									<a class="btn btn-secondary" href="{% url list_view_name %}">
										Cancelar
									</a>
								</div>
							</form>
						</div>
					</div>
				</div>
			</main>
		</div>
	{% endblock principalcomponent %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  const solicitudSel = document.getElementById("id_id_solicitud_vale");
  const socioSel     = document.getElementById("id_id_socio");
  const comercioSel  = document.getElementById("id_id_comercio");
  const importeInput = document.getElementById("id_monto_compra");

  if (!solicitudSel || !socioSel || !comercioSel || !importeInput) return;

  const urlBase = "{% url 'solicitud_vale_info' 0 %}".replace("/0/", "/");

  async function cargarDatosSolicitud(svId) {
    if (!svId) return;

    try {
      const resp = await fetch(urlBase + svId + "/", {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      if (!resp.ok) return;
      const data = await resp.json();

      if (data.id_socio) socioSel.value = String(data.id_socio);
      if (data.id_comercio) comercioSel.value = String(data.id_comercio);

      // ðŸ‘‰ completar importe con el aprobado
      if (data.importe_aprobado) {
        importeInput.value = data.importe_aprobado;
      }

      socioSel.dispatchEvent(new Event("change"));
      comercioSel.dispatchEvent(new Event("change"));

    } catch (e) {
      console.error("Error AJAX solicitud_vale_info:", e);
    }
  }

  solicitudSel.addEventListener("change", () => {
    cargarDatosSolicitud(solicitudSel.value);
  });

  if (solicitudSel.value) {
    cargarDatosSolicitud(solicitudSel.value);
  }
});
</script>
	

{% endblock maincomponent %}
<!-- -------------------------------------------------------------------- -->
{% block modals %}
	<!-- Modal para mostrar errores -->
	{% include 'modal_errors.html' %}
	
	<!-- Modal para mostrar los requerimientos de los campos -->
	{% include 'maestros/modal_fields_requirements.html' %}
{% endblock modals %}
<!-- -------------------------------------------------------------------- -->
